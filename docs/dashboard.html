<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Always Up</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav container">
            <a href="index.html" class="logo">
                üîç Always Up
            </a>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="https://urlcollect.onrender.com" target="_blank">Submit Site</a></li>
            </ul>
        </nav>
    </header>

    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <h1>Website Status Dashboard</h1>
            <p>Real-time monitoring status for all registered websites</p>
        </div>
    </section>

    <!-- Dashboard Content -->
    <section class="section">
        <div class="container">
            <div class="dashboard-controls">
                <div>
                    <h3 id="status-count">Loading...</h3>
                    <p style="color: var(--text-muted); margin: 0;">Last updated: <span id="last-updated">Never</span></p>
                </div>
                <button id="refresh-btn" class="btn btn-secondary refresh-btn">
                    üîÑ Refresh
                </button>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading">
                <div class="pulse">üîÑ Loading website status...</div>
            </div>

            <!-- Error State -->
            <div id="error" class="error" style="display: none;">
                <h3>‚ö†Ô∏è Unable to Load Data</h3>
                <p>We couldn't fetch the website status data. This might be because:</p>
                <ul style="text-align: left; max-width: 400px; margin: 1rem auto;">
                    <li>The sites.json file doesn't exist yet</li>
                    <li>No websites have been added to monitoring</li>
                    <li>There's a network connectivity issue</li>
                </ul>
                <button id="retry-btn" class="btn" style="margin-top: 1rem;">
                    Try Again
                </button>
            </div>

            <!-- Status Grid -->
            <div id="status-grid" class="status-grid" style="display: none;">
                <!-- Dynamic content will be inserted here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="loading" style="display: none;">
                <h3>üåü No Websites Being Monitored Yet</h3>
                <p>Start monitoring your first website by submitting it through our form.</p>
                <a href="https://urlcollect.onrender.com" class="btn" target="_blank" style="margin-top: 1rem;">
                    Submit Your Website
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Always Up. Keeping your websites online, always.</p>
            <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                Data refreshes automatically every 5 minutes via GitHub Actions
            </p>
        </div>
    </footer>

    <script>
        class DashboardManager {
            constructor() {
                this.refreshBtn = document.getElementById('refresh-btn');
                this.statusGrid = document.getElementById('status-grid');
                this.loading = document.getElementById('loading');
                this.error = document.getElementById('error');
                this.emptyState = document.getElementById('empty-state');
                this.statusCount = document.getElementById('status-count');
                this.lastUpdated = document.getElementById('last-updated');
                this.retryBtn = document.getElementById('retry-btn');
                
                this.initializeEventListeners();
                this.loadData();
                
                // Auto refresh every 2 minutes
                setInterval(() => this.loadData(), 120000);
            }
            
            initializeEventListeners() {
                this.refreshBtn.addEventListener('click', () => this.loadData());
                this.retryBtn.addEventListener('click', () => this.loadData());
            }
            
            async loadData() {
                this.showLoading();
                this.updateRefreshButton(true);
                
                try {
                    const response = await fetch(
    location.hostname.includes('github.io')
        ? 'https://raw.githubusercontent.com/connectsanand/alwaysUp/main/sites.json'
        : '/sites.json'
);

                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data || (!Array.isArray(data) && !data.sites)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Handle both array format and object with sites property
                    const sites = Array.isArray(data) ? data : (data.sites || []);
                    
                    if (sites.length === 0) {
                        this.showEmptyState();
                    } else {
                        this.renderSites(sites);
                        this.showStatusGrid();
                    }
                    
                    this.updateLastRefreshed();
                    
                } catch (error) {
                    console.error('Error loading sites data:', error);
                    this.showError();
                } finally {
                    this.updateRefreshButton(false);
                }
            }
            
            renderSites(sites) {
                const sitesHTML = sites.map(site => this.createSiteCard(site)).join('');
                this.statusGrid.innerHTML = sitesHTML;
                this.statusCount.textContent = `${sites.length} Website${sites.length !== 1 ? 's' : ''} Monitored`;
            }
            
            createSiteCard(site) {
                // Handle different possible data structures
                const url = site.url || site.site || site.domain || site.name || 'Unknown URL';
                const status = this.determineStatus(site);
                const lastChecked = this.formatLastChecked(site);
                const responseTime = this.getResponseTime(site);
                
                return `
                    <div class="status-card fade-in-up">
                        <div class="status-header">
                            <div class="site-url">${this.escapeHtml(url)}</div>
                            <div class="status-badge ${status.class}">${status.text}</div>
                        </div>
                        <div class="status-details">
                            <span>Last checked: ${lastChecked}</span>
                            ${responseTime ? `<span>Response time: ${responseTime}</span>` : ''}
                        </div>
                    </div>
                `;
            }
            
            determineStatus(site) {
                // Check various possible status indicators
                if (site.status === 'up' || site.status === 'online' || site.up === true) {
                    return { class: 'status-up', text: 'Up' };
                } else if (site.status === 'down' || site.status === 'offline' || site.up === false) {
                    return { class: 'status-down', text: 'Down' };
                } else {
                    return { class: 'status-unknown', text: 'Unknown' };
                }
            }
            
            formatLastChecked(site) {
                const lastChecked = site.lastChecked || site.last_checked || site.timestamp || site.updated;
                
                if (!lastChecked) {
                    return 'Never';
                }
                
                try {
                    const date = new Date(lastChecked);
                    if (isNaN(date.getTime())) {
                        return 'Invalid date';
                    }
                    
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (diffMins < 1) {
                        return 'Just now';
                    } else if (diffMins < 60) {
                        return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
                    } else if (diffMins < 1440) {
                        const hours = Math.floor(diffMins / 60);
                        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                    } else {
                        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                } catch (error) {
                    return 'Invalid date';
                }
            }
            
            getResponseTime(site) {
                const responseTime = site.responseTime || site.response_time || site.ping;
                if (responseTime && typeof responseTime === 'number') {
                    return `${responseTime}ms`;
                }
                return null;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            showLoading() {
                this.hideAllStates();
                this.loading.style.display = 'block';
            }
            
            showError() {
                this.hideAllStates();
                this.error.style.display = 'block';
                this.statusCount.textContent = 'Unable to load data';
            }
            
            showEmptyState() {
                this.hideAllStates();
                this.emptyState.style.display = 'block';
                this.statusCount.textContent = 'No websites monitored';
            }
            
            showStatusGrid() {
                this.hideAllStates();
                this.statusGrid.style.display = 'grid';
                
                // Trigger animations for new cards
                setTimeout(() => {
                    document.querySelectorAll('.status-card').forEach((card, index) => {
                        setTimeout(() => {
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, index * 100);
                    });
                }, 50);
            }
            
            hideAllStates() {
                this.loading.style.display = 'none';
                this.error.style.display = 'none';
                this.emptyState.style.display = 'none';
                this.statusGrid.style.display = 'none';
            }
            
            updateRefreshButton(loading) {
                if (loading) {
                    this.refreshBtn.textContent = 'üîÑ Refreshing...';
                    this.refreshBtn.disabled = true;
                    this.refreshBtn.style.opacity = '0.6';
                } else {
                    this.refreshBtn.textContent = 'üîÑ Refresh';
                    this.refreshBtn.disabled = false;
                    this.refreshBtn.style.opacity = '1';
                }
            }
            
            updateLastRefreshed() {
                const now = new Date();
                this.lastUpdated.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
        }
        
        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
        
        // Add CSS for card animations
        const style = document.createElement('style');
        style.textContent = `
            .status-card {
                opacity: 0;
                transform: translateY(20px);
                transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>